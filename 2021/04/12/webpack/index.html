<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Webpack工具链 · Chio's Personal Website</title><meta name="description" content="Webpack工具链 - Chio"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/chio.github.io/favicon.png"><link rel="stylesheet" href="/chio.github.io/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://chiokotomi.github.io/chio.github.io/atom.xml" title="Chio's Personal Website"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/chio.github.io/atom.xml" title="Chio's Personal Website" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/chio.github.io/" class="logo-link"><img src="/chio.github.io/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/chio.github.io/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="/chio.github.io/archives/" target="_self" class="nav-list-link">文章</a></li><li class="nav-list-item"><a href="https://weibo.com/u/2001366581" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/chiokotomi" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Webpack工具链</h1><div class="post-info">Apr 12, 2021</div><div class="post-content"><p><code>webpack</code>是模块打包工具，管理模块依赖，并编译输出模块们所需的静态文件。</p>
<span id="more"></span>
<p>可管理所有静态资源文件：html、js、css、图片、字体等。</p>
<p>不同类型资源使用不同的<code>loader</code></p>
<p>webpack自动分析模块间<code>依赖关系</code>，最后生成优化合并后的静态资源。</p>
<p><code>插件</code>提供了处理各种文件过程中的生命周期钩子，可以开发者自定义功能。</p>
<h1 id="核心打包原理"><a href="#核心打包原理" class="headerlink" title="核心打包原理"></a>核心打包原理</h1><h2 id="主要流程"><a href="#主要流程" class="headerlink" title="主要流程"></a>主要流程</h2><ol>
<li>读取入口文件内容</li>
<li>分析入口文件，递归查找模块依赖文件内容，生成AST语法树</li>
<li>根据AST语法树，生成浏览器可执行代码</li>
</ol>
<h2 id="过程步骤"><a href="#过程步骤" class="headerlink" title="过程步骤"></a>过程步骤</h2><ol>
<li>读取模块内容</li>
<li>分析模块</li>
<li>收集依赖</li>
<li>ES6转成ES5（AST）</li>
<li>递归获取所有依赖</li>
<li>处理两个关键字：import exports</li>
<li>输出打包结果</li>
</ol>
<h2 id="步骤实现"><a href="#步骤实现" class="headerlink" title="步骤实现"></a>步骤实现</h2><ol>
<li>获取主模块内容</li>
<li>分析模块<ul>
<li>安装<code>@babel/parser</code>转AST</li>
</ul>
</li>
<li>对模块内容进行处理<ul>
<li><code>@babel/travers</code>包遍历AST收集依赖</li>
<li><code>@babel/core</code>和<code>@babel/preset-env</code>包ES6转ES5</li>
</ul>
</li>
<li>递归处理所有模块</li>
<li>生成最终代码</li>
</ol>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 手写webpack核心打包流程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 获取主入口文件</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">&#x27;@babel/parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">&#x27;@babel/traverse&#x27;</span>).default;</span><br><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">&#x27;@babel/core&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析单个文件，获取文件路径，依赖文件列表，编译成es5的代码</span></span><br><span class="line"><span class="keyword">const</span> getModuleInfo = <span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> body = fs.readFileSync(path.resolve(__dirname, file), <span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">    <span class="comment">// 新增代码</span></span><br><span class="line">    <span class="keyword">const</span> ast = parser.parse(body, &#123;</span><br><span class="line">        sourceType: <span class="string">&#x27;module&#x27;</span> <span class="comment">// 表示我们要解析的是ES模块</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新增代码</span></span><br><span class="line">    <span class="keyword">const</span> deps = &#123;&#125;;</span><br><span class="line">    traverse(ast, &#123;</span><br><span class="line">        <span class="function"><span class="title">ImportDeclaration</span>(<span class="params">&#123;node&#125;</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> dirname = path.dirname(file);</span><br><span class="line">            <span class="keyword">const</span> abspath = <span class="string">&#x27;./&#x27;</span> + path.join(dirname, node.source.value);</span><br><span class="line">            deps[node.source.value] = abspath;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> &#123;code&#125; = babel.transformFromAst(ast, <span class="literal">null</span>, &#123;</span><br><span class="line">        presets: [<span class="string">&#x27;@babel/preset-env&#x27;</span>]</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> moduleInfo = &#123;file, deps, code&#125;;</span><br><span class="line">    <span class="keyword">return</span> moduleInfo;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译入口文件，非递归遍历AST依赖树，将所有文件解析后生成平铺的映射对象</span></span><br><span class="line"><span class="keyword">const</span> parseModules = <span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> entry = getModuleInfo(file);</span><br><span class="line">    <span class="keyword">const</span> temp = [entry];</span><br><span class="line">    <span class="keyword">const</span> depsGraph = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; temp.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> deps = temp[i].deps;</span><br><span class="line">        <span class="keyword">if</span> (deps) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> deps) &#123;</span><br><span class="line">                <span class="keyword">if</span> (deps.hasOwnProperty(key)) &#123;</span><br><span class="line">                    temp.push(getModuleInfo(deps[key]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    temp.forEach(<span class="function"><span class="params">moduleInfo</span> =&gt;</span> &#123;</span><br><span class="line">        depsGraph[moduleInfo.file] = &#123;</span><br><span class="line">            deps: moduleInfo.deps,</span><br><span class="line">            code: moduleInfo.code</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> depsGraph;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打包，生成递归遍历执行依赖关系树的执行器和AST依赖关系树</span></span><br><span class="line"><span class="keyword">const</span> bundle = <span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> depsGraph = <span class="built_in">JSON</span>.stringify(parseModules(file), <span class="literal">null</span>, <span class="number">4</span>);</span><br><span class="line">     <span class="keyword">return</span> <span class="string">`;(function (graph) &#123;</span></span><br><span class="line"><span class="string">        function require(file) &#123;</span></span><br><span class="line"><span class="string">            function absRequire(relPath) &#123;</span></span><br><span class="line"><span class="string">                return require(graph[file].deps[relPath])</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            var exports = &#123;&#125;;</span></span><br><span class="line"><span class="string">            (function (require, exports, code) &#123;</span></span><br><span class="line"><span class="string">                eval(code);</span></span><br><span class="line"><span class="string">            &#125;)(absRequire, exports, graph[file].code);</span></span><br><span class="line"><span class="string">            return exports;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        require(&#x27;<span class="subst">$&#123;file&#125;</span>&#x27;);</span></span><br><span class="line"><span class="string">    &#125;)(<span class="subst">$&#123;depsGraph&#125;</span>);`</span>;</span><br><span class="line">&#125;；</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> entry = <span class="string">&#x27;./src/index.js&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> content = bundle(entry);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (!fs.existsSync(<span class="string">&#x27;./dist&#x27;</span>)) &#123;</span><br><span class="line">    fs.mkdirSync(<span class="string">&#x27;./dist&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">fs.writeFileSync(<span class="string">&#x27;./dist/bundle.js&#x27;</span>, content);</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></article></div></main><footer><div class="paginator"><a href="/chio.github.io/2021/04/14/ES6%20Object.defineProperty/" class="prev">PREV</a><a href="/chio.github.io/2021/04/10/vue3/" class="next">NEXT</a></div><div class="copyright"><p>© 2020 - 2021 <a href="https://chiokotomi.github.io/chio.github.io">Chio</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>